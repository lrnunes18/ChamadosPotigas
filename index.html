<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atendimentos • Potigás (v26.0 Enterprise Monolith)</title>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts" defer></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ============================================================================================
      SEÇÃO 2: DESIGN SYSTEM & VARIÁVEIS CSS
      ============================================================================================
      Definição completa da paleta de cores, espaçamentos e comportamentos globais.
    */
    :root {
      /* Cores de Fundo (Dark Theme) */
      --bg-body: #0d1117;
      --bg-panel: #161b22;
      --bg-header: #010409;
      --bg-input: #21262d;
      --bg-hover: #30363d;
      
      /* Cores da Marca (Identity) */
      --primary: #238636;
      --primary-hover: #2ea043;
      --primary-light: rgba(35, 134, 54, 0.15);
      
      /* Tipografia e Texto */
      --text-main: #e6edf3;
      --text-muted: #8b949e;
      --text-inverse: #ffffff;

      /* Bordas e Separadores */
      --border: #30363d;
      --border-radius: 6px;
      
      /* Cores Semânticas (Status) */
      --danger: #da3633;
      --danger-bg: rgba(218, 54, 51, 0.1);
      
      --warning: #d29922;
      --warning-bg: rgba(210, 153, 34, 0.1);
      
      --info: #58a6ff;
      --info-bg: rgba(88, 166, 255, 0.1);
      
      --success: #238636;
      
      /* Dimensões de Layout */
      --header-height: 64px;
      --sidebar-width: 240px;
    }

    /* ============================================================================================
      SEÇÃO 3: RESET CSS E BASE
      ============================================================================================
    */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
      outline: none;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden; /* A rolagem acontece apenas dentro dos painéis */
    }

    /* Classe utilitária para travar o cursor durante o redimensionamento de colunas */
    body.is-resizing {
      cursor: col-resize !important;
      user-select: none;
    }

    /* Estilização Avançada da Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-body);
      border-left: 1px solid var(--border);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
      border: 2px solid var(--bg-body);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================================================================================
      SEÇÃO 4: COMPONENTES DE INTERFACE (UI)
      ============================================================================================
    */
    
    /* --- Inputs, Selects e Textareas --- */
    input, 
    select, 
    textarea, 
    button {
      font-family: inherit;
      font-size: 0.85rem;
      color: var(--text-main);
      background-color: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      padding: 8px 12px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input:focus, 
    select:focus, 
    textarea:focus {
      border-color: var(--text-muted);
      box-shadow: 0 0 0 2px rgba(139, 148, 158, 0.2);
    }

    input::placeholder {
      color: #565d66;
    }

    /* --- Botões --- */
    button {
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 500;
      user-select: none;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    /* Botão Primário (Verde) */
    .btn-primary {
      background-color: var(--primary);
      color: #ffffff;
      border: 1px solid var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    /* Botão Ghost (Transparente) */
    .btn-ghost {
      background-color: transparent;
      border-color: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      background-color: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
    }

    /* Botão Ícone (Quadrado) */
    .btn-icon {
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: 1px solid transparent;
      background-color: transparent;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .btn-icon:hover {
      background-color: var(--bg-hover);
      color: var(--text-main);
      border-color: var(--border);
    }

    .btn-icon.danger:hover {
      background-color: var(--danger-bg);
      color: var(--danger);
      border-color: transparent;
    }

    /* ============================================================================================
      SEÇÃO 5: LOADING E FEEDBACK (OVERLAYS)
      ============================================================================================
    */
    
    /* Overlay de Carregamento (Spinner) */
    #loadingOverlay {
      position: fixed;
      inset: 0; /* top, right, bottom, left = 0 */
      background-color: rgba(13, 17, 23, 0.95);
      z-index: 99999;
      display: none; /* Controlado via JS */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid var(--bg-input);
      border-top: 6px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: 20px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-main);
      letter-spacing: 0.5px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Sistema de Notificações (Toasts) */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none; /* Permite clicar através do container */
    }

    .toast {
      background-color: var(--bg-panel);
      border-left: 4px solid var(--primary);
      padding: 15px 25px;
      border-radius: 6px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      min-width: 320px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 15px;
      pointer-events: auto;
      animation: slideInRight 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      border: 1px solid var(--border);
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.info { border-left-color: var(--info); }
    .toast.warning { border-left-color: var(--warning); }

    .toast i {
      font-size: 1.4rem;
    }

    @keyframes slideInRight {
      from { transform: translateX(120%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ============================================================================================
      SEÇÃO 6: LAYOUT PRINCIPAL (HEADER, NAV, CONTAINER)
      ============================================================================================
    */
    
    /* Barra Superior */
    .topbar {
      height: var(--header-height);
      background-color: var(--bg-header);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 25px;
      flex-shrink: 0;
    }

    .brand {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-main);
      letter-spacing: -0.5px;
    }

    .brand i {
      color: var(--primary);
      font-size: 1.6rem;
    }

    /* Barra de Abas */
    .tabs {
      display: flex;
      gap: 5px;
      padding: 0 25px;
      background-color: var(--bg-header);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .tab-btn {
      padding: 15px 20px;
      background-color: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
      position: relative;
      top: 1px;
    }

    .tab-btn:hover {
      color: var(--text-main);
      background-color: rgba(255, 255, 255, 0.03);
    }

    .tab-btn.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    /* Container Principal */
    .main-container {
      flex: 1;
      overflow: hidden;
      position: relative;
      display: flex;
      background-color: var(--bg-body);
    }

    /* Painéis de Visão */
    .view-panel {
      display: none;
      flex: 1;
      flex-direction: column;
      padding: 25px;
      overflow: hidden;
      height: 100%;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .view-panel.active {
      display: flex;
      opacity: 1;
    }

    /* ============================================================================================
      SEÇÃO 7: PAINEL DE CONTROLE (KPIS, TOOLBAR, GRID)
      ============================================================================================
    */
    
    /* Container de KPIs */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
      flex-shrink: 0;
    }

    .kpi-card {
      background-color: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .kpi-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 12px rgba(0,0,0,0.2);
      border-color: var(--text-muted);
    }

    /* Indicador Colorido Lateral */
    .kpi-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }
    .kpi-card.blue::before { background-color: var(--info); }
    .kpi-card.orange::before { background-color: var(--warning); }
    .kpi-card.green::before { background-color: var(--success); }
    .kpi-card.red::before { background-color: var(--danger); }

    .kpi-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .kpi-value {
      font-size: 2.2rem;
      font-weight: 800;
      margin-top: 10px;
      color: var(--text-main);
      line-height: 1;
    }

    .kpi-sub {
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Barra de Ferramentas (Toolbar) */
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      align-items: center;
      background-color: var(--bg-panel);
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      flex-shrink: 0;
    }

    .search-wrap {
      position: relative;
      display: flex;
      align-items: center;
      flex-grow: 1;
      max-width: 400px;
    }

    .search-wrap i {
      position: absolute;
      left: 12px;
      color: var(--text-muted);
      font-size: 1.1rem;
    }

    .search-wrap input {
      padding-left: 38px;
      width: 100%;
    }

    /* Seletor de Intervalo de Data */
    .date-range {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: var(--bg-input);
      border: 1px solid var(--border);
      padding: 0 12px;
      border-radius: 6px;
      height: 38px;
    }

    .date-range input {
      border: none;
      background: transparent;
      padding: 0;
      width: 120px;
      color: var(--text-main);
      height: 100%;
    }

    .date-range span {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .filter-select {
      min-width: 160px;
    }

    /* Divisor Vertical */
    .v-divider {
      width: 1px;
      height: 24px;
      background-color: var(--border);
      margin: 0 10px;
    }

    /* Grid / Tabela */
    .grid-frame {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: var(--bg-panel);
      overflow: hidden;
      position: relative;
    }

    .grid-scroll {
      flex: 1;
      overflow: auto;
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      border-right: 1px solid var(--border);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }

    /* Cabeçalho da Tabela */
    th {
      background-color: #1e2228;
      position: sticky;
      top: 0;
      z-index: 10;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      user-select: none;
      letter-spacing: 0.5px;
    }

    /* Estilos de Linha (SLA) */
    tr.row-critical td:first-child {
      border-left: 3px solid var(--danger);
    }

    tr.row-late {
      background-color: rgba(210, 153, 34, 0.05);
    }

    tr:hover {
      background-color: var(--bg-hover);
    }

    /* Checkbox */
    .col-check {
      width: 45px;
      text-align: center;
      padding: 0;
    }

    input[type="checkbox"] {
      cursor: pointer;
      accent-color: var(--primary);
      width: 16px;
      height: 16px;
    }

    /* Componentes dentro do Header (Sort/Resize) */
    .th-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      cursor: pointer;
      height: 100%;
    }

    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      z-index: 11;
      transition: background 0.2s;
    }

    .resizer:hover,
    .resizing {
      background-color: var(--primary);
    }

    /* Célula Editável */
    td.editable {
      cursor: cell;
    }

    td.editable:hover {
      background-color: rgba(255, 255, 255, 0.04);
      box-shadow: inset 0 0 0 1px var(--border);
    }

    .inline-input {
      width: 100%;
      height: 100%;
      margin: -8px -10px;
      padding: 8px 10px;
      background-color: var(--bg-input);
      color: white;
      border: 2px solid var(--primary);
      font-size: 13px;
      border-radius: 4px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    /* Badges (Status) */
    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      border: 1px solid transparent;
      display: inline-block;
    }

    .st-pendente { background: var(--warning-bg); color: var(--warning); border-color: rgba(210, 153, 34, 0.3); }
    .st-concluido { background: rgba(35, 134, 54, 0.15); color: #238636; border-color: rgba(35, 134, 54, 0.3); }
    .crit-alta { background: var(--danger-bg); color: var(--danger); border-color: rgba(248, 81, 73, 0.3); }
    .crit-media { background: var(--warning-bg); color: var(--warning); }
    .crit-baixa { background: var(--info-bg); color: var(--info); }

    /* Rodapé (Paginação) */
    .grid-footer {
      height: 50px;
      border-top: 1px solid var(--border);
      background-color: var(--bg-header);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      flex-shrink: 0;
    }

    /* ==============================================================================================
       SEÇÃO 8: ELEMENTOS FLUTUANTES (MENUS, BULK, ETC)
       ============================================================================================== */
    
    .dropdown-wrap { position: relative; }

    .dropdown-menu {
      position: absolute;
      top: 110%;
      left: 0;
      background-color: var(--bg-panel);
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 6px;
      z-index: 100;
      width: 260px;
      display: none;
      flex-direction: column;
      gap: 2px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .dropdown-menu.show { display: flex; }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      color: var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .menu-item:hover {
      background-color: var(--bg-hover);
      color: var(--text-main);
    }

    /* Barra de Bulk Actions */
    .bulk-bar {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background-color: var(--primary);
      color: white;
      padding: 12px 30px;
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6);
      z-index: 100;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }

    .bulk-bar.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    /* ==============================================================================================
       SEÇÃO 9: MODAIS (SISTEMA COMPLETO)
       ============================================================================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.open { display: flex; }

    .modal-box {
      background-color: #1c2128;
      width: 750px;
      max-width: 95%;
      padding: 0;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 25px 50px rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      max-height: 90vh;
    }

    .modal-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--bg-panel);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .modal-tabs {
      display: flex;
      background-color: var(--bg-input);
      padding: 0 25px;
      border-bottom: 1px solid var(--border);
    }

    .modal-tab {
      padding: 15px 20px;
      cursor: pointer;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      font-size: 0.9rem;
      font-weight: 600;
      transition: color 0.2s;
    }

    .modal-tab:hover { color: var(--text-main); }

    .modal-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .modal-content {
      padding: 25px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-tab-pane { display: none; }
    .modal-tab-pane.active { display: block; }

    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background-color: var(--bg-panel);
    }

    /* Formulários */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full { grid-column: span 2; }

    .form-group label {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    /* Chat de Comentários */
    .chat-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding-right: 10px;
    }

    .chat-item {
      background-color: var(--bg-body);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .chat-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .audit-log {
      font-family: 'Consolas', 'Courier New', monospace;
      font-size: 0.85rem;
      color: var(--text-muted);
      max-height: 300px;
      overflow-y: auto;
      background-color: var(--bg-body);
      padding: 15px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .audit-item {
      border-bottom: 1px solid var(--border);
      padding: 8px 0;
    }

    /* ==============================================================================================
       SEÇÃO 11: CADASTROS (CARDS)
       ============================================================================================== */
    .cad-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      padding-bottom: 50px;
    }

    .cad-card {
      background-color: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      height: 450px;
      overflow: hidden;
    }

    .cad-head {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: rgba(255,255,255,0.02);
    }

    .cad-list {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cad-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: var(--bg-input);
      border-radius: 6px;
      border: 1px solid transparent;
      transition: 0.2s;
    }

    .cad-row:hover {
      border-color: var(--border);
      background-color: var(--bg-hover);
    }

    .cad-input-area {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      background-color: var(--bg-panel);
    }

    /* Lista de Arquivos */
    .file-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--bg-body);
      padding: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .file-item a {
      color: var(--info);
      text-decoration: none;
      font-weight: 500;
    }

    .file-item a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p style="margin-top:20px; font-weight:600; color:var(--text-main)" id="loadingText">
      Conectando ao Google Sheets...
    </p>
  </div>

  <div id="toastContainer" class="toast-wrap"></div>
  
  <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none" onchange="processarImportacao(this)">

  <header class="topbar">
    <div class="brand">
      <i class="ph-fill ph-fire"></i>
      <span>Atendimentos <small style="color:var(--text-muted); font-weight:400; margin-left:5px">Potigás</small></span>
    </div>
    
    <div style="display:flex; gap:15px; align-items:center">
      <select id="topUser" class="btn-ghost" style="border:none; font-weight:600; padding-right:0"></select>
      
      <span class="badge st-concluido" id="statusBadge">
          <i class="ph-fill ph-cloud-check"></i> Nuvem Ativa
      </span>
      
      <button class="btn-icon" onclick="forceSync()" title="Forçar Sincronização">
        <i class="ph ph-arrows-clockwise"></i>
      </button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab-btn active" onclick="switchTab('painel')">Painel de Controle</button>
    <button class="tab-btn" onclick="switchTab('dashboards')">Dashboards</button>
    <button class="tab-btn" onclick="switchTab('cadastros')">Cadastros</button>
  </nav>

  <div class="main-container">
    
    <div id="painel" class="view-panel active">
      
      <div class="kpi-container">
         <div class="kpi-card blue">
            <span class="kpi-label">Total Registros</span>
            <span id="kpiTotal" class="kpi-value">0</span>
            <span class="kpi-sub">Visíveis no grid</span>
         </div>
         <div class="kpi-card orange">
            <span class="kpi-label">Pendentes</span>
            <span id="kpiPending" class="kpi-value">0</span>
            <span class="kpi-sub">Aguardando ação</span>
         </div>
         <div class="kpi-card red">
            <span class="kpi-label">Alta Prioridade</span>
            <span id="kpiCrit" class="kpi-value">0</span>
            <span class="kpi-sub">Criticidade Alta</span>
         </div>
         <div class="kpi-card green">
            <span class="kpi-label">Concluídos</span>
            <span id="kpiDone" class="kpi-value">0</span>
            <span class="kpi-sub">Processo finalizado</span>
         </div>
      </div>

      <div class="toolbar">
        <div class="search-wrap">
          <i class="ph ph-magnifying-glass"></i>
          <input id="txtBusca" placeholder="Pesquisar em tudo..." onkeyup="filtrarGrid(true)">
        </div>
        
        <div class="date-range">
            <input type="date" id="fDataIni" onchange="filtrarGrid(true)">
            <span>até</span>
            <input type="date" id="fDataFim" onchange="filtrarGrid(true)">
        </div>

        <select id="fGerencia" class="filter-select" onchange="filtrarGrid(true)"></select>
        <select id="fAnalista" class="filter-select" onchange="filtrarGrid(true)"></select>
        <select id="fStatus" class="filter-select" onchange="filtrarGrid(true)"></select>
        
        <div class="v-divider"></div>

        <div class="dropdown-wrap">
          <button class="btn-ghost" onclick="toggleDropdown('colMenu')">
            <i class="ph ph-columns"></i> Colunas
          </button>
          <div id="colMenu" class="dropdown-menu">
            <div id="colList"></div>
            <div style="height:1px; background:var(--border); margin:5px 0"></div>
            <button class="btn-ghost" style="width:100%; justify-content:center" onclick="addNovaColuna()">+ Nova Coluna</button>
          </div>
        </div>

        <button class="btn-ghost" onclick="document.getElementById('fileInput').click()">
          <i class="ph ph-upload-simple"></i> Importar
        </button>
        <button class="btn-ghost" onclick="exportarXLSX()">
          <i class="ph ph-download-simple"></i> Exportar
        </button>
        
        <div style="flex:1"></div>
        
        <button class="btn-primary" onclick="abrirModalCadastro()">
          <i class="ph ph-plus"></i> Novo Atendimento
        </button>
      </div>

      <div class="grid-frame">
        <div class="grid-scroll">
          <table id="gridTable">
            <thead id="gridHead"></thead>
            <tbody id="gridBody"></tbody>
          </table>
        </div>
        <div class="grid-footer">
          <span id="pageInfo" style="color:var(--text-muted)">0 registros</span>
          
          <div style="display:flex; gap:15px; align-items:center">
            <button class="btn-ghost btn-icon" onclick="toggleDensity()" title="Alternar Densidade">
                <i class="ph ph-rows"></i>
            </button>
            
            <div class="v-divider" style="height:15px"></div>

            <button class="btn-icon" onclick="mudarPagina(-1)"><i class="ph ph-caret-left"></i></button>
            <span id="pageLabel" style="padding:0 10px; font-weight:600">1 / 1</span>
            <button class="btn-icon" onclick="mudarPagina(1)"><i class="ph ph-caret-right"></i></button>
          </div>
        </div>
      </div>

      <div id="bulkBar" class="bulk-bar">
        <span id="bulkCount" style="font-weight:700">0 selecionados</span>
        <div style="width:1px; height:20px; background:rgba(255,255,255,0.3)"></div>
        
        <button class="btn-ghost" style="color:white; border-color:white" onclick="abrirBulkEdit()">
            <i class="ph ph-pencil-simple"></i> Editar em Massa
        </button>
        
        <button class="btn-ghost" style="color:white; background:rgba(248,81,73,0.4); border:none" onclick="bulkDelete()">
            <i class="ph ph-trash"></i> Excluir
        </button>
        
        <button class="btn-icon" onclick="limparSelecao()" style="color:white; margin-left:10px">
            <i class="ph ph-x"></i>
        </button>
      </div>
    </div>

    <div id="dashboards" class="view-panel">
      <div class="cad-container">
        <div class="cad-card" style="padding:20px">
           <h3 style="color:var(--text-muted); margin-bottom:15px; font-size:1rem">Atendimentos por Analista</h3>
           <div id="chartAnalistas"></div>
        </div>
        <div class="cad-card" style="padding:20px">
           <h3 style="color:var(--text-muted); margin-bottom:15px; font-size:1rem">Status Geral</h3>
           <div id="chartStatus"></div>
        </div>
        <div class="cad-card" style="padding:20px">
           <h3 style="color:var(--text-muted); margin-bottom:15px; font-size:1rem">Distribuição de Criticidade</h3>
           <div id="chartCrit"></div>
        </div>
      </div>
    </div>

    <div id="cadastros" class="view-panel">
      <div class="cad-container">
        <div id="card-gerencias" class="cad-card"></div>
        <div id="card-analistas" class="cad-card"></div>
        <div id="card-usuarios" class="cad-card"></div>
        <div id="card-periodos" class="cad-card"></div>
        <div id="card-status" class="cad-card"></div>
        <div id="card-criticidade" class="cad-card"></div>
      </div>
    </div>

  </div>

  <div id="modalCadastro" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <h3 id="modalTitle">Registro</h3>
        <button class="btn-icon" onclick="fecharModal('modalCadastro')"><i class="ph ph-x"></i></button>
      </div>
      
      <div class="modal-tabs">
          <div class="modal-tab active" onclick="switchModalTab('tab-dados')">Dados</div>
          <div class="modal-tab" onclick="switchModalTab('tab-comments')">Comentários</div>
          <div class="modal-tab" onclick="switchModalTab('tab-history')">Histórico</div>
      </div>

      <form onsubmit="salvarRegistro(event)" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
        <input type="hidden" id="editId">
        
        <div class="modal-content">
            <div id="tab-dados" class="modal-tab-pane active">
                <div id="formFields" class="form-grid"></div>
            </div>

            <div id="tab-comments" class="modal-tab-pane">
                <div id="chatList" class="chat-list"></div>
                <div style="display:flex; gap:10px">
                    <input id="newComment" placeholder="Digite uma observação..." style="flex:1">
                    <button type="button" class="btn-primary" onclick="addComment()">Enviar</button>
                </div>
            </div>

            <div id="tab-history" class="modal-tab-pane">
                <div id="auditLog" class="audit-log"></div>
            </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-ghost" onclick="fecharModal('modalCadastro')">Cancelar</button>
          <button type="submit" class="btn-primary" id="btnSave">Salvar Registro</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modalAnexos" class="modal-overlay">
    <div class="modal-box" style="width:500px">
      <div class="modal-header">
        <h3>Gerenciar Anexos</h3>
        <button class="btn-icon" onclick="fecharModal('modalAnexos')"><i class="ph ph-x"></i></button>
      </div>
      <div class="modal-content">
         <input type="hidden" id="anexoId">
         <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem">
            Adicione links externos (Google Drive, SharePoint) ou nomes de arquivos.
         </p>
         <div style="display:flex; gap:10px; margin-bottom:20px">
            <input id="novoAnexo" placeholder="Cole o link aqui..." style="flex:1">
            <button class="btn-primary" onclick="adicionarAnexo()">Adicionar</button>
         </div>
         <div id="listaAnexos" class="file-list"></div>
      </div>
    </div>
  </div>

  <div id="modalBulk" class="modal-overlay">
    <div class="modal-box" style="width:450px">
      <div class="modal-header">
        <h3>Edição em Massa</h3>
        <button class="btn-icon" onclick="fecharModal('modalBulk')"><i class="ph ph-x"></i></button>
      </div>
      <div class="modal-content">
        <p style="color:var(--text-muted); margin-bottom:25px; font-size:1rem">
            Você está prestes a alterar <b id="bulkTotal" style="color:var(--primary)">0</b> registros selecionados.
        </p>
        
        <div class="form-group">
            <label>Qual campo deseja alterar?</label>
            <select id="bulkField" style="width:100%" onchange="atualizarInputBulk()"></select>
        </div>
        
        <div class="form-group" style="margin-top:20px">
            <label>Novo Valor</label>
            <div id="bulkValueContainer"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-ghost" onclick="fecharModal('modalBulk')">Cancelar</button>
        <button type="button" class="btn-primary" onclick="aplicarBulk()">Aplicar Alterações</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * ----------------------------------------------------------------------------------
     * MÓDULO 1: CONFIGURAÇÃO E ESTADO DA APLICAÇÃO
     * ----------------------------------------------------------------------------------
     */
    
    // ⚠️ URL DO GOOGLE APPS SCRIPT - COLE AQUI ⚠️
    const API_URL = "https://script.google.com/macros/s/AKfycbzWrQ4CKUU4r0zmuF1x7BL10XNJuBQaen422luGx2XkCoKvFooJAD0aOI7nmswhzaNl/exec"; 

    // Dados Padrão (Fallback para quando estiver offline ou inicializando)
    const defaultDB = {
        gerencias: ["GTI", "GFIN", "GCONT", "GCOM", "GRH", "GO&M", "GPLAR", "GTEC"],
        analistas: ["Guilherme Maia", "Thiago Magalhães", "Sergio Costa", "Ana Paula", "João Silva", "Mariana Souza"],
        usuarios: ["Emmanuelle", "Ivomar Godeiro", "Francisco Antonio", "Ricardo Wagner", "Wilbert Queiroz"],
        periodos: ["09/2025", "10/2025", "11/2025", "12/2025", "01/2026", "02/2026", "03/2026"],
        status: ["Pend. T.I", "Pend. User", "Concluído", "Fechado", "Em Análise"],
        criticidade: ["Alta", "Média", "Baixa", "Crítico"]
    };

    // Definição das Colunas do Sistema
    const defaultCols = [
      { id: 'id', label: 'ID (UUID)', width: '50px', type: 'readonly' },
      { id: 'chamado', label: 'Chamado', width: '100px', type: 'text' },
      { id: 'demanda', label: 'Demanda', width: '250px', type: 'text', full: true },
      { id: 'data_abertura', label: 'Data Abertura', width: '110px', type: 'date' },
      { id: 'gerencia', label: 'Gerência', width: '130px', type: 'select', source: 'gerencias' },
      { id: 'analista', label: 'Analista', width: '130px', type: 'select', source: 'analistas' },
      { id: 'status', label: 'Status', width: '110px', type: 'select', source: 'status' },
      { id: 'criticidade', label: 'Criticidade', width: '100px', type: 'select', source: 'criticidade' },
      { id: 'usuario', label: 'Usuário Resp.', width: '130px', type: 'select', source: 'usuarios' },
      { id: 'anexos', label: 'Anexos', width: '70px', type: 'special_file' }
    ];

    // Inicialização do Estado da Aplicação
    let db = JSON.parse(JSON.stringify(defaultDB));
    let dados = [];
    
    // Recupera configuração de colunas localmente para manter preferências do usuário
    let cols = JSON.parse(localStorage.getItem('pg_cols_v26')) || JSON.parse(JSON.stringify(defaultCols));
    
    // Controles de Interface
    let visibleCols = new Set(cols.map(c => c.id));
    let sortConfig = { col: null, order: 'asc' };
    let selectedIds = new Set();
    let currentPage = 1;
    const itemsPerPage = 15;
    let filteredData = []; // Cache de dados após filtragem

    /**
     * ----------------------------------------------------------------------------------
     * MÓDULO 2: INICIALIZAÇÃO E SINCRONIZAÇÃO (NETWORKING)
     * ----------------------------------------------------------------------------------
     */
    
    window.onload = () => {
        // Verificação de Segurança da URL
        if (API_URL.includes("COLE_SUA")) {
            alert("ATENÇÃO: Você precisa colar a URL do Script na linha indicada no código!");
        }
        
        syncData(); // Inicia o processo de sincronização
        
        // Listener Global para fechar menus dropdown
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.dropdown-wrap')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            }
        });
    };

    // Função Principal de Sincronização (GET)
    async function syncData() {
        toggleLoading(true, "Sincronizando com a Nuvem...");
        
        try {
            const response = await fetch(API_URL);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            
            const json = await response.json();
            
            // Atualiza o estado local com os dados da nuvem
            if (json.dados) dados = json.dados;
            if (json.db) db = json.db;

            // Atualiza toda a interface
            renderAllComponents();
            
            // Atualiza indicador de status
            document.getElementById('statusBadge').className = "badge st-concluido";
            document.getElementById('statusBadge').innerHTML = '<i class="ph-fill ph-cloud-check"></i> Conectado';
            showToast("Dados sincronizados com sucesso!", "success");

        } catch (err) {
            console.error("Erro de Sincronização:", err);
            
            document.getElementById('statusBadge').className = "badge st-pendente";
            document.getElementById('statusBadge').innerHTML = '<i class="ph-fill ph-warning"></i> Offline';
            showToast("Falha na conexão. Usando modo offline.", "error");
            
            // Se não houver dados, cria um registro de exemplo para a UI não quebrar
            if (dados.length === 0) {
                dados = [{
                    id: crypto.randomUUID(), 
                    chamado: "Local", 
                    demanda: "Modo Offline Ativo", 
                    data_abertura: new Date().toISOString().split('T')[0], 
                    status: "Pendente", 
                    criticidade: "Alta",
                    anexos: [],
                    history: []
                }];
            }
            renderAllComponents();
        } finally {
            toggleLoading(false);
        }
    }
    
    // Função para forçar sincronização manual
    function forceSync() {
        syncData();
    }

    // Função central que redesenha toda a tela
    function renderAllComponents() {
        populateFilters();
        renderCadastros();
        renderColMenu();
        filtrarGrid(true); // Renderiza grid resetando a página
        updateCharts();
        updateKPIs();
        
        // Atualiza seletor de usuário no topo
        const userSelect = document.getElementById('topUser');
        if (db.usuarios && db.usuarios.length > 0) {
            userSelect.innerHTML = db.usuarios.map(u => `<option>${u}</option>`).join('');
        } else {
            userSelect.innerHTML = '<option>Admin</option>';
        }
    }

    // Função Genérica de Envio para API (POST)
    async function sendToApi(action, payload) {
        toggleLoading(true, "Salvando dados...");
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                // Usamos text/plain para evitar CORS Preflight em alguns ambientes
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ 
                    action: action, 
                    data: payload 
                })
            });
            
            const json = await response.json();
            
            if (json.result === 'success') {
                // A API retorna os dados atualizados, garantindo a verdade única
                if (json.content.dados) dados = json.content.dados;
                if (json.content.db) db = json.content.db;
                
                renderAllComponents();
                return true;
            } else {
                throw new Error(json.error || "Erro desconhecido na API");
            }
        } catch (err) {
            console.error(err);
            showToast("Erro ao salvar: " + err.message, "error");
            return false;
        } finally {
            toggleLoading(false);
        }
    }

    /**
     * ----------------------------------------------------------------------------------
     * MÓDULO 3: GRID, FILTROS E PAGINAÇÃO
     * ----------------------------------------------------------------------------------
     */
    
    function filtrarGrid(resetPage = false) {
        if (resetPage) currentPage = 1;
        
        // Captura valores dos filtros
        const busca = document.getElementById('txtBusca').value.toLowerCase();
        const fGer = document.getElementById('fGerencia').value;
        const fAna = document.getElementById('fAnalista').value;
        const fStat = document.getElementById('fStatus').value;
        const dIni = document.getElementById('fDataIni').value;
        const dFim = document.getElementById('fDataFim').value;

        // Aplica lógica de filtragem
        filteredData = dados.filter(d => {
            // 1. Busca Textual Global
            const txtMatch = Object.values(d).some(v => {
                return v && String(v).toLowerCase().includes(busca);
            });
            if (!txtMatch) return false;

            // 2. Filtros de Seleção
            if (fGer && d.gerencia !== fGer) return false;
            if (fAna && d.analista !== fAna) return false;
            if (fStat && d.status !== fStat) return false;

            // 3. Filtro de Data (Range)
            if (dIni || dFim) {
                if (!d.data_abertura) return false;
                if (dIni && d.data_abertura < dIni) return false;
                if (dFim && d.data_abertura > dFim) return false;
            }
            
            return true;
        });

        // Aplica Ordenação
        if (sortConfig.col) {
            filteredData.sort((a, b) => {
                let valA = a[sortConfig.col] || '';
                let valB = b[sortConfig.col] || '';
                
                // Tenta converter para número para ordenação correta
                if (!isNaN(valA) && !isNaN(valB) && valA !== '' && valB !== '') {
                    valA = Number(valA);
                    valB = Number(valB);
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }
                
                if (valA < valB) return sortConfig.order === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.order === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        renderGrid();
        updateKPIs();
    }

    function renderGrid() {
        const tbody = document.getElementById('gridBody');
        const thead = document.getElementById('gridHead');
        
        // --- Construção do Cabeçalho ---
        let headHtml = `<tr><th class="col-check"><input type="checkbox" onchange="toggleSelectAll(this)"></th>`;
        
        cols.forEach(c => {
            if (!visibleCols.has(c.id)) return;
            
            let style = '';
            let icon = '';
            
            // Indicador de Ordenação
            if (sortConfig.col === c.id) {
                style = 'color:var(--primary)';
                icon = sortConfig.order === 'asc' 
                    ? '<i class="ph-fill ph-caret-up"></i>' 
                    : '<i class="ph-fill ph-caret-down"></i>';
            }
            
            headHtml += `<th style="width:${c.width}">
                <div class="th-inner" style="${style}" onclick="doSort('${c.id}')">
                   <span>${c.label}</span> ${icon}
                </div>
                <div class="resizer" onmousedown="initResize(event, '${c.id}')"></div>
            </th>`;
        });
        
        headHtml += `<th style="width:90px">Ações</th></tr>`;
        thead.innerHTML = headHtml;

        // --- Paginação ---
        const total = filteredData.length;
        const totalPages = Math.ceil(total / itemsPerPage) || 1;
        
        // Correção de página inválida
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        const start = (currentPage - 1) * itemsPerPage;
        const pageData = filteredData.slice(start, start + itemsPerPage);
        
        // Atualiza rodapé
        document.getElementById('pageInfo').innerText = `${total} registros encontrados`;
        document.getElementById('pageLabel').innerText = `${currentPage} / ${totalPages}`;

        // --- Construção do Corpo da Tabela ---
        tbody.innerHTML = pageData.map(d => {
            const isSel = selectedIds.has(d.id);
            let rowClass = "";
            let alertIcon = "";
            
            // SLA: Criticidade Alta
            if (d.criticidade === 'Alta' || d.criticidade === 'Crítico') {
                rowClass += " row-critical";
            }
            
            // SLA: Atraso (> 7 dias)
            if (d.data_abertura && (d.status && d.status.includes('Pend'))) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(d.data_abertura)) / (1000 * 60 * 60 * 24));
                if (diffDays > 7) {
                    rowClass += " row-late";
                    alertIcon = `<i class="ph-fill ph-fire" style="color:var(--danger); margin-left:5px" title="Atrasado (+7 dias)"></i>`;
                }
            }

            let rowHtml = `<tr class="${rowClass}" style="${isSel ? 'background:rgba(35,134,54,0.15)' : ''}">
              <td class="col-check">
                  <input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleSelect('${d.id}')">
              </td>`;
            
            cols.forEach(c => {
                if (!visibleCols.has(c.id)) return;
                
                let val = d[c.id] || '';
                let display = val;

                // Formatação Condicional de Badges
                if (c.id === 'status') {
                    let cls = 'badge';
                    if (val.includes('Concluído') || val.includes('Fechado')) cls = 'st-concluido';
                    else if (val.includes('Pend')) cls = 'st-pendente';
                    display = `<span class="badge ${cls}">${val}</span>`;
                } 
                else if (c.id === 'criticidade') {
                    let cls = 'badge';
                    if (val === 'Alta' || val === 'Crítico') cls = 'crit-alta';
                    else if (val === 'Média') cls = 'crit-media';
                    else cls = 'crit-baixa';
                    display = `<span class="badge ${cls}">${val}</span>`;
                } 
                else if (c.type === 'date' && val) {
                    // Formata data YYYY-MM-DD para DD/MM/YYYY
                    display = val.split('-').reverse().join('/');
                } 
                else if (c.type === 'special_file') {
                    const qtd = (d.anexos || []).length;
                    const color = qtd > 0 ? 'var(--primary)' : 'var(--text-muted)';
                    display = `<button class="btn-icon" style="color:${color}" onclick="abrirAnexos('${d.id}')">
                        <i class="ph-fill ph-paperclip"></i> ${qtd || ''}
                    </button>`;
                }
                
                // Ícone de alerta no Chamado
                if (c.id === 'chamado') display += alertIcon;

                // Célula com Edição Inline
                if (c.type !== 'special_file' && c.id !== 'id') {
                    const safeVal = String(val).replace(/"/g, '&quot;');
                    rowHtml += `<td class="editable" ondblclick="inlineEdit(this, '${d.id}', '${c.id}', '${safeVal}')">${display}</td>`;
                } else {
                    rowHtml += `<td>${display}</td>`;
                }
            });
            
            // Botões de Ação
            rowHtml += `<td>
               <div style="display:flex; gap:5px">
                 <button class="btn-icon" onclick="abrirModalCadastro('${d.id}')" title="Editar">
                    <i class="ph ph-pencil-simple"></i>
                 </button>
                 <button class="btn-icon danger" onclick="excluirRegistro('${d.id}')" title="Excluir">
                    <i class="ph ph-trash"></i>
                 </button>
               </div>
            </td></tr>`;
            
            return rowHtml;
        }).join('');
        
        updateBulkBar();
    }

    // ----------------------------------------------------------------------------------
    // MÓDULO 4: CADASTRO E EDIÇÃO (CRUD COMPLETO)
    // ----------------------------------------------------------------------------------
    
    function abrirModalCadastro(id = null) {
        document.getElementById('editId').value = id || '';
        document.getElementById('modalTitle').innerText = id ? 'Editar Registro' : 'Novo Registro';
        
        switchModalTab('tab-dados'); // Reseta para a primeira aba

        const item = id ? dados.find(d => d.id == id) : {};
        const container = document.getElementById('formFields');
        container.innerHTML = '';

        // Geração dinâmica dos campos do formulário
        cols.forEach(c => {
            if (c.id === 'id' || c.type === 'special_file') return; // Ignora ID e Anexos
            
            const div = document.createElement('div');
            div.className = `form-group ${c.full ? 'full' : ''}`;
            div.innerHTML = `<label>${c.label}</label>`;
            
            let input;
            const val = item[c.id] || '';
            
            // Se tiver fonte de dados (db), cria Select
            if (c.source && db[c.source]) {
                input = `<select id="in_${c.id}" style="width:100%">
                    <option value="">Selecione...</option>
                    ${db[c.source].map(o => `<option ${o == val ? 'selected' : ''}>${o}</option>`).join('')}
                </select>`;
            } else {
                // Senão, cria Input normal
                let type = c.type === 'date' ? 'date' : 'text';
                input = `<input id="in_${c.id}" type="${type}" value="${val}" style="width:100%">`;
            }
            div.innerHTML += input;
            container.appendChild(div);
        });
        
        // Carrega Comentários e Histórico
        if (id) {
             renderComments(item.comments || []);
             renderAudit(item.history || []);
        } else {
             document.getElementById('chatList').innerHTML = '<p style="padding:20px; text-align:center; color:var(--text-muted)">Salve o registro para adicionar comentários.</p>';
             document.getElementById('auditLog').innerHTML = '';
        }
        
        toggleModal('modalCadastro', true);
    }

    async function salvarRegistro(e) {
        e.preventDefault();
        const id = document.getElementById('editId').value;
        const user = document.getElementById('topUser').value;
        
        // Se for edição, clona o objeto. Se for novo, cria estrutura.
        let novo = id ? { ...dados.find(d => d.id == id) } : { 
            id: crypto.randomUUID(), 
            anexos: [], 
            comments: [], 
            history: [] 
        };
        
        let changes = [];

        // Captura valores do formulário e detecta mudanças
        cols.forEach(c => {
            if (c.id !== 'id' && c.type !== 'special_file') {
                const el = document.getElementById(`in_${c.id}`);
                if (el && novo[c.id] != el.value) {
                    changes.push(`${c.label}: ${el.value}`);
                    novo[c.id] = el.value;
                }
            }
        });

        // Adiciona Log de Auditoria
        if (changes.length > 0 || !id) {
            const action = id ? "Editado" : "Criado";
            const logEntry = `${new Date().toLocaleString()} - ${user}: ${action}. ${changes.join(', ')}`;
            
            if (!novo.history) novo.history = [];
            novo.history.unshift(logEntry);
        }

        // Envia para a API
        const success = await sendToApi('save', novo);
        if (success) { 
            toggleModal('modalCadastro', false); 
            showToast('Salvo com sucesso!', 'success'); 
        }
    }

    async function excluirRegistro(id) {
        if (confirm('Deseja realmente excluir este registro?')) {
            const success = await sendToApi('delete', { id: id });
            if (success) showToast('Registro excluído.', 'info');
        }
    }

    // ----------------------------------------------------------------------------------
    // MÓDULO 5: EDIÇÃO INLINE (NA CÉLULA)
    // ----------------------------------------------------------------------------------
    function inlineEdit(td, id, colId, val) {
        // Evita recriar se já estiver editando
        if (td.querySelector('.inline-input')) return;
        
        const col = cols.find(c => c.id === colId);
        let html = '';
        
        if (col.source && db[col.source]) {
            html = `<select class="inline-input" onblur="salvarInline(this,'${id}','${colId}')" onkeydown="if(event.key==='Enter') event.target.blur()">
                ${db[col.source].map(o => `<option ${o == val ? 'selected' : ''}>${o}</option>`).join('')}
            </select>`;
        } else {
            let type = col.type === 'date' ? 'date' : 'text';
            html = `<input type="${type}" class="inline-input" value="${val}" onblur="salvarInline(this,'${id}','${colId}')" onkeydown="if(event.key==='Enter') event.target.blur()">`;
        }
        
        td.innerHTML = html;
        td.querySelector('.inline-input').focus();
    }

    async function salvarInline(el, id, colId) {
        const row = dados.find(d => d.id == id);
        
        // Só salva se o valor mudou
        if (row && row[colId] != el.value) {
            let copy = { ...row };
            copy[colId] = el.value;
            
            // Log simples
            if (!copy.history) copy.history = [];
            copy.history.unshift(`${new Date().toLocaleString()} - Inline Edit: ${colId} alterado.`);
            
            const success = await sendToApi('save', copy);
            if (success) showToast('Atualizado!', 'success');
        } else {
            renderGrid(); // Restaura visualização normal
        }
    }

    // ----------------------------------------------------------------------------------
    // MÓDULO 6: CADASTROS AUXILIARES
    // ----------------------------------------------------------------------------------
    function renderCadastros() {
        const keys = ['gerencias', 'analistas', 'usuarios', 'status', 'criticidade', 'periodos'];
        
        keys.forEach(key => {
            const el = document.getElementById(`card-${key}`);
            if (el) {
                const title = key.charAt(0).toUpperCase() + key.slice(1);
                el.innerHTML = `
                   <div class="cad-head">
                       <span>${title}</span>
                       <span class="badge st-pendente">${(db[key] || []).length}</span>
                   </div>
                   <div class="cad-list">
                       ${(db[key] || []).map(v => `
                           <div class="cad-row">
                               <span>${v}</span>
                               <button class="btn-icon danger" onclick="delCad('${key}','${v}')">
                                   <i class="ph ph-trash"></i>
                               </button>
                           </div>
                       `).join('')}
                   </div>
                   <div class="cad-input-area">
                      <input id="new-${key}" placeholder="Novo..." style="flex:1" onkeydown="if(event.key==='Enter') addCad('${key}')">
                      <button class="btn-primary" onclick="addCad('${key}')">+</button>
                   </div>
                `;
            }
        });
    }

    async function addCad(key) {
        const v = document.getElementById(`new-${key}`).value.trim();
        if (v && !db[key].includes(v)) { 
            db[key].push(v); 
            await sendToApi('config', db); 
        }
    }

    async function delCad(key, v) {
        if (confirm(`Remover "${v}"?`)) { 
            db[key] = db[key].filter(x => x !== v); 
            await sendToApi('config', db); 
        }
    }

    // ----------------------------------------------------------------------------------
    // MÓDULO 7: HELPERS E UTILITÁRIOS DE UI
    // ----------------------------------------------------------------------------------
    
    function toggleLoading(show, msg) { 
        const el = document.getElementById('loadingOverlay');
        el.style.display = show ? 'flex' : 'none'; 
        if (msg) document.getElementById('loadingText').innerText = msg; 
    }

    function showToast(msg, type = 'info') {
        const div = document.createElement('div'); 
        div.className = `toast ${type}`;
        
        let icon = type === 'success' ? 'ph-check-circle' : (type === 'error' ? 'ph-warning-circle' : 'ph-info');
        div.innerHTML = `<i class="ph-fill ${icon}"></i> ${msg}`;
        
        document.getElementById('toastContainer').appendChild(div);
        setTimeout(() => div.remove(), 3500);
    }

    function toggleModal(id, open) { 
        const el = document.getElementById(id);
        if (open) el.classList.add('open'); else el.classList.remove('open');
    }
    
    function fecharModal(id) { toggleModal(id, false); }

    function switchTab(id) {
        document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        if (id === 'dashboards') updateCharts();
        if (id === 'cadastros') renderCadastros();
    }

    function toggleDropdown(id) { 
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; 
    }

    function populateFilters() { 
        const fill = (id, list) => {
            const el = document.getElementById(id);
            if(el) el.innerHTML = `<option value="">Todos</option>` + (list || []).map(i => `<option>${i}</option>`).join(''); 
        };
        fill('fGerencia', db.gerencias); 
        fill('fAnalista', db.analistas); 
        fill('fStatus', db.status);
    }

    function doSort(colId) { 
        if (sortConfig.col === colId) sortConfig.order = sortConfig.order === 'asc' ? 'desc' : 'asc';
        else { sortConfig.col = colId; sortConfig.order = 'asc'; }
        filtrarGrid(false); 
    }

    function mudarPagina(delta) { 
        currentPage += delta; 
        renderGrid(); 
    }

    function toggleSelect(id) { 
        if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); 
        renderGrid(); 
    }

    function toggleSelectAll(chk) { 
        if (chk.checked) filteredData.forEach(d => selectedIds.add(d.id)); 
        else selectedIds.clear(); 
        renderGrid(); 
    }

    function limparSelecao() { 
        selectedIds.clear(); 
        renderGrid(); 
    }

    function updateBulkBar() { 
        const b = document.getElementById('bulkBar'); 
        if (selectedIds.size > 0) { 
            b.classList.add('visible'); 
            document.getElementById('bulkCount').innerText = `${selectedIds.size} selecionados`; 
        } else {
            b.classList.remove('visible'); 
        }
    }

    function toggleDensity() {
        document.getElementById('gridTable').classList.toggle('compact');
    }

    function resetFactory() {
        if (confirm('Deseja resetar o cache local? (Não apaga a nuvem)')) {
            localStorage.clear(); 
            location.reload(); 
        }
    }

    // --- GRÁFICOS ---
    function updateCharts() {
        if (typeof ApexCharts === 'undefined') return;
        
        const countBy = (field) => { 
            const map = {}; 
            dados.forEach(d => { if (d[field]) map[d[field]] = (map[d[field]] || 0) + 1; }); 
            return map; 
        };
        
        const renderChart = (id, type, data) => {
            document.getElementById(id).innerHTML = '';
            new ApexCharts(document.querySelector(`#${id}`), {
                chart: { type, height: 280, background: 'transparent', toolbar: { show: false } },
                theme: { mode: 'dark' },
                series: type === 'bar' ? [{ data: Object.values(data) }] : Object.values(data),
                labels: Object.keys(data),
                xaxis: { categories: Object.keys(data) },
                colors: ['#238636', '#d29922', '#f85149', '#58a6ff']
            }).render();
        };
        
        renderChart('chartAnalistas', 'bar', countBy('analista'));
        renderChart('chartStatus', 'donut', countBy('status'));
        renderChart('chartCrit', 'pie', countBy('criticidade'));
    }

    function updateKPIs() {
        document.getElementById('kpiTotal').innerText = filteredData.length;
        // Adicione lógica para os outros KPIs aqui se desejar
    }

    // --- MENU DE COLUNAS ---
    function renderColMenu() {
        document.getElementById('colList').innerHTML = cols.map(c => {
            const visible = visibleCols.has(c.id);
            return `
                <div class="menu-item" onclick="toggleCol('${c.id}')">
                    <span>${c.label}</span>
                    ${visible ? '<i class="ph-fill ph-eye" style="color:var(--primary)"></i>' : '<i class="ph ph-eye-slash"></i>'}
                </div>`;
        }).join('');
    }

    function toggleCol(id) {
        if (visibleCols.has(id)) visibleCols.delete(id); else visibleCols.add(id);
        renderColMenu();
        renderGrid();
    }

    function addNovaColuna() {
        const name = prompt("Nome da Nova Coluna:");
        if (name) {
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '') + '_' + Date.now();
            cols.push({ id: id, label: name, width: '150px', type: 'text' });
            localStorage.setItem('pg_cols_v26', JSON.stringify(cols)); // Salva preferência local
            renderColMenu();
            renderGrid();
        }
    }

    // --- REDIMENSIONAMENTO ---
    function initResize(e, colId) {
        const th = e.target.closest('th');
        const startX = e.pageX;
        const startW = th.offsetWidth;
        
        document.body.classList.add('is-resizing');
        
        function mouseMove(ev) {
            const nw = startW + (ev.pageX - startX);
            if (nw > 50) th.style.width = nw + 'px';
        }
        
        function mouseUp() {
            document.body.classList.remove('is-resizing');
            const c = cols.find(x => x.id === colId);
            if (c) c.width = th.style.width; // Salva largura
            
            window.removeEventListener('mousemove', mouseMove);
            window.removeEventListener('mouseup', mouseUp);
        }
        
        window.addEventListener('mousemove', mouseMove);
        window.addEventListener('mouseup', mouseUp);
    }

    // --- ANEXOS ---
    function abrirAnexos(id) {
        document.getElementById('anexoId').value = id;
        const row = dados.find(d => d.id == id);
        renderListaAnexos(row ? (row.anexos || []) : []);
        toggleModal('modalAnexos', true);
    }

    function renderListaAnexos(list) {
        const div = document.getElementById('listaAnexos');
        div.innerHTML = list.length === 0 
           ? '<p style="padding:10px;color:#666">Nenhum anexo.</p>' 
           : list.map((f, i) => `
               <div class="file-item">
                   <a href="${f.startsWith('http') ? f : '#'}" target="_blank">${f}</a>
                   <button class="btn-icon danger" onclick="rmAnexo(${i})"><i class="ph ph-trash"></i></button>
               </div>
           `).join('');
    }

    async function adicionarAnexo() {
        const id = document.getElementById('anexoId').value;
        const val = document.getElementById('novoAnexo').value;
        if (val) {
            const row = dados.find(d => d.id == id);
            if (!row.anexos) row.anexos = [];
            row.anexos.push(val);
            
            await sendToApi('save', row);
            renderListaAnexos(row.anexos);
            document.getElementById('novoAnexo').value = '';
        }
    }

    async function rmAnexo(index) {
        const id = document.getElementById('anexoId').value;
        const row = dados.find(d => d.id == id);
        row.anexos.splice(index, 1);
        await sendToApi('save', row);
        renderListaAnexos(row.anexos);
    }

    // --- BULK EDIT ---
    function abrirBulkEdit() {
        const select = document.getElementById('bulkField');
        select.innerHTML = cols.filter(c => c.id !== 'id' && c.type !== 'special_file')
            .map(c => `<option value="${c.id}">${c.label}</option>`).join('');
        
        document.getElementById('bulkTotal').innerText = selectedIds.size;
        atualizarInputBulk();
        toggleModal('modalBulk', true);
    }

    function atualizarInputBulk() {
        const fid = document.getElementById('bulkField').value;
        const col = cols.find(c => c.id === fid);
        const container = document.getElementById('bulkValueContainer');
        
        if (col.source && db[col.source]) {
            container.innerHTML = `<select id="bulkValue" style="width:100%">
                ${db[col.source].map(o => `<option>${o}</option>`).join('')}
            </select>`;
        } else {
            container.innerHTML = `<input id="bulkValue" style="width:100%">`;
        }
    }

    async function aplicarBulk() {
        const f = document.getElementById('bulkField').value;
        const v = document.getElementById('bulkValue').value;
        
        toggleLoading(true);
        // Salva um por um (Apps Script pode demorar, idealmente backend teria suporte a batch)
        for (let id of selectedIds) {
            let r = dados.find(d => d.id == id);
            if (r) {
                r[f] = v;
                await sendToApi('save', r);
            }
        }
        toggleLoading(false);
        toggleModal('modalBulk', false);
        limparSelecao();
        showToast('Atualizado em massa!', 'success');
    }

    async function bulkDelete() {
        if (confirm('Excluir selecionados?')) {
            toggleLoading(true);
            for (let id of selectedIds) {
                await sendToApi('delete', { id: id });
            }
            toggleLoading(false);
            limparSelecao();
            showToast('Excluídos!', 'info');
        }
    }

    // --- MODAL TAB ---
    function switchModalTab(tabId) {
        document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.modal-tab-pane').forEach(el => el.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // --- CHAT / COMENTÁRIOS ---
    function renderComments(list) {
        document.getElementById('chatList').innerHTML = list.map(c => `
            <div class="chat-item">
                <div class="chat-meta"><span>${c.user}</span><span>${c.date}</span></div>
                <div>${c.text}</div>
            </div>
        `).join('');
    }

    async function addComment() {
        const id = document.getElementById('editId').value;
        const txt = document.getElementById('newComment').value;
        if (txt && id) {
            const row = dados.find(d => d.id == id);
            if (!row.comments) row.comments = [];
            
            row.comments.unshift({
                user: document.getElementById('topUser').value,
                date: new Date().toLocaleString(),
                text: txt
            });
            
            await sendToApi('save', row);
            document.getElementById('newComment').value = '';
            renderComments(row.comments);
        }
    }

    function renderAudit(list) {
        document.getElementById('auditLog').innerHTML = list.map(l => `<div class="audit-item">${l}</div>`).join('');
    }

    // --- IMPORTAÇÃO / EXPORTAÇÃO (XLSX) ---
    function processarImportacao(input) {
        const f = input.files[0];
        if (!f) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            json.forEach(row => {
                let novo = { 
                    id: crypto.randomUUID(), 
                    anexos: [], comments: [], history: [] 
                };
                
                cols.forEach(c => {
                    if (c.id !== 'id' && c.type !== 'special_file') {
                        // Tenta encontrar coluna pelo nome (Case Insensitive)
                        const k = Object.keys(row).find(x => x.toLowerCase() === c.label.toLowerCase());
                        if (k) novo[c.id] = row[k];
                    }
                });
                
                dados.push(novo);
                // Nota: Em produção, enviaríamos todos de uma vez. Aqui enviamos o último para disparar o save.
            });
            
            // Salva o último para forçar sync (Simplificação)
            sendToApi('save', dados[dados.length - 1]);
            showToast('Importação concluída!', 'success');
            input.value = '';
            filtrarGrid(true);
        };
        reader.readAsArrayBuffer(f);
    }

    function exportarXLSX() {
        const exportData = dados.map(d => {
            let r = {};
            cols.forEach(c => {
                if (c.id !== 'anexos' && visibleCols.has(c.id)) {
                    r[c.label] = d[c.id];
                }
            });
            return r;
        });
        
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dados");
        XLSX.writeFile(wb, "Potigas_Relatorio.xlsx");
    }

  </script>
</body>
</html>
