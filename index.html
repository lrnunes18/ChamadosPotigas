<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Atendimentos • Potigás (v27.0 Enterprise Secure)</title>

  <script src="https://cdn.jsdelivr.net/npm/apexcharts" defer></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    /* ============================================================================================
      SEÇÃO 2: DESIGN SYSTEM & VARIÁVEIS CSS
      ============================================================================================
    */
    :root {
      /* Cores de Fundo (Dark Theme) */
      --bg-body: #0d1117;
      --bg-panel: #161b22;
      --bg-header: #010409;
      --bg-input: #21262d;
      --bg-hover: #30363d;
      
      /* Cores da Marca */
      --primary: #238636;
      --primary-hover: #2ea043;
      --primary-light: rgba(35, 134, 54, 0.15);
      
      /* Tipografia */
      --text-main: #e6edf3;
      --text-muted: #8b949e;
      --text-inverse: #ffffff;

      /* Bordas */
      --border: #30363d;
      --border-radius: 6px;
      
      /* Status */
      --danger: #da3633;
      --danger-bg: rgba(218, 54, 51, 0.1);
      --warning: #d29922;
      --warning-bg: rgba(210, 153, 34, 0.1);
      --info: #58a6ff;
      --info-bg: rgba(88, 166, 255, 0.1);
      --success: #238636;
      
      /* Dimensões */
      --header-height: 64px;
      --sidebar-width: 240px;
    }

    /* ============================================================================================
      SEÇÃO 3: RESET E BASE
      ============================================================================================
    */
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; 
      outline: none; 
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-size: 13px;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden; 
    }

    body.is-resizing { cursor: col-resize !important; user-select: none; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); border-left: 1px solid var(--border); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; border: 2px solid var(--bg-body); }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ============================================================================================
      SEÇÃO 4: TELA DE LOGIN (NOVO)
      ============================================================================================
    */
    #loginScreen {
        position: fixed;
        inset: 0;
        z-index: 20000;
        background-color: var(--bg-body);
        display: flex;
        align-items: center;
        justify-content: center;
        background-image: radial-gradient(circle at center, #161b22 0%, #0d1117 100%);
    }

    .login-card {
        width: 400px;
        padding: 40px;
        background: var(--bg-panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        text-align: center;
        animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .login-logo {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 10px;
        display: flex; justify-content: center;
    }

    .login-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: var(--text-main);
    }

    .login-subtitle {
        color: var(--text-muted);
        margin-bottom: 30px;
        font-size: 0.9rem;
    }

    .login-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Inputs de Login Específicos */
    .login-input {
        padding: 12px 15px;
        background: var(--bg-input);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: white;
        font-size: 14px;
        transition: 0.2s;
        width: 100%;
    }
    .login-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(35, 134, 54, 0.2); }

    .login-btn {
        padding: 12px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: 0.2s;
        width: 100%;
    }
    .login-btn:hover { background: var(--primary-hover); }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ============================================================================================
      SEÇÃO 5: CONTAINER DA APLICAÇÃO (ESCONDIDO INICIALMENTE)
      ============================================================================================
    */
    #appContainer {
        display: none; /* Escondido até o login */
        flex-direction: column;
        height: 100%;
        width: 100%;
    }

    /* ============================================================================================
      SEÇÃO 6: COMPONENTES DE UI GERAIS
      ============================================================================================
    */
    
    /* Inputs Gerais (Não afeta o login pois usamos classes especificas lá, mas garantimos o seletor :not) */
    input:not(.login-input), select, textarea, button:not(.login-btn) {
      font-family: inherit;
      font-size: 0.85rem;
      color: var(--text-main);
      background-color: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--border-radius);
      padding: 8px 12px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--text-muted);
      box-shadow: 0 0 0 2px rgba(139, 148, 158, 0.2);
    }

    input::placeholder { color: #565d66; }

    /* Botões */
    button { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-primary { background-color: var(--primary); color: #fff; border: 1px solid var(--primary); font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    
    .btn-ghost { background-color: transparent; border-color: transparent; color: var(--text-muted); }
    .btn-ghost:hover { background-color: rgba(255, 255, 255, 0.08); color: var(--text-main); }

    .btn-icon { padding: 0; width: 32px; height: 32px; border-radius: 6px; border: 1px solid transparent; background-color: transparent; color: var(--text-muted); display: inline-flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .btn-icon:hover { background-color: var(--bg-hover); color: var(--text-main); border-color: var(--border); }
    .btn-icon.danger:hover { background-color: var(--danger-bg); color: var(--danger); border-color: transparent; }

    /* ============================================================================================
      SEÇÃO 7: ESTRUTURA (TOPO, TABS)
      ============================================================================================
    */
    .topbar { height: var(--header-height); background-color: var(--bg-header); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; flex-shrink: 0; }
    .brand { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 12px; color: var(--text-main); letter-spacing: -0.5px; }
    .brand i { color: var(--primary); font-size: 1.6rem; }

    /* User Info no Topo */
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-badge { text-align: right; line-height: 1.2; }
    .user-name { font-weight: 700; color: var(--text-main); font-size: 0.9rem; }
    .user-role { font-size: 0.75rem; color: var(--text-muted); }

    .tabs { display: flex; gap: 5px; padding: 0 25px; background-color: var(--bg-header); border-bottom: 1px solid var(--border); flex-shrink: 0; }
    .tab-btn { padding: 15px 20px; background-color: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 600; cursor: pointer; font-size: 0.9rem; position: relative; top: 1px; }
    .tab-btn:hover { color: var(--text-main); background-color: rgba(255, 255, 255, 0.03); }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

    .main-container { flex: 1; overflow: hidden; position: relative; display: flex; background-color: var(--bg-body); }
    .view-panel { display: none; flex: 1; flex-direction: column; padding: 25px; overflow: hidden; height: 100%; opacity: 0; transition: opacity 0.2s; }
    .view-panel.active { display: flex; opacity: 1; }

    /* ============================================================================================
      SEÇÃO 8: PAINEL (KPIS, TOOLBAR, GRID)
      ============================================================================================
    */
    .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 25px; flex-shrink: 0; }
    .kpi-card { background-color: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
    .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 12px rgba(0,0,0,0.2); border-color: var(--text-muted); }
    .kpi-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .kpi-card.blue::before { background-color: var(--info); }
    .kpi-card.orange::before { background-color: var(--warning); }
    .kpi-card.green::before { background-color: var(--success); }
    .kpi-card.red::before { background-color: var(--danger); }
    .kpi-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
    .kpi-value { font-size: 2.2rem; font-weight: 800; margin-top: 10px; color: var(--text-main); line-height: 1; }
    .kpi-sub { margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); }

    .toolbar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; background-color: var(--bg-panel); padding: 15px; border: 1px solid var(--border); border-radius: 8px; flex-shrink: 0; }
    .search-wrap { position: relative; display: flex; align-items: center; flex-grow: 1; max-width: 400px; }
    .search-wrap i { position: absolute; left: 12px; color: var(--text-muted); font-size: 1.1rem; }
    .search-wrap input { padding-left: 38px; width: 100%; }
    .date-range { display: flex; align-items: center; gap: 10px; background-color: var(--bg-input); border: 1px solid var(--border); padding: 0 12px; border-radius: 6px; height: 38px; }
    .date-range input { border: none; background: transparent; padding: 0; width: 120px; color: var(--text-main); height: 100%; }
    .date-range span { color: var(--text-muted); font-size: 0.9rem; }
    .filter-select { min-width: 160px; }
    .v-divider { width: 1px; height: 24px; background-color: var(--border); margin: 0 10px; }

    .grid-frame { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: 6px; background-color: var(--bg-panel); overflow: hidden; position: relative; }
    .grid-scroll { flex: 1; overflow: auto; position: relative; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle; }
    th { background-color: #1e2228; position: sticky; top: 0; z-index: 10; font-weight: 600; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; user-select: none; letter-spacing: 0.5px; }
    tr.row-critical td:first-child { border-left: 3px solid var(--danger); }
    tr.row-late { background-color: rgba(210, 153, 34, 0.05); }
    tr:hover { background-color: var(--bg-hover); }
    table.compact th, table.compact td { padding: 6px 10px; font-size: 12px; }

    .col-check { width: 45px; text-align: center; padding: 0; }
    input[type="checkbox"] { cursor: pointer; accent-color: var(--primary); width: 16px; height: 16px; }

    .th-inner { display: flex; align-items: center; justify-content: space-between; width: 100%; cursor: pointer; }
    .th-inner:hover { color: var(--text-main); }
    .resizer { position: absolute; right: 0; top: 0; bottom: 0; width: 6px; cursor: col-resize; z-index: 11; transition: background 0.2s; }
    .resizer:hover, .resizing { background-color: var(--primary); }

    td.editable { cursor: cell; }
    td.editable:hover { background-color: rgba(255, 255, 255, 0.04); box-shadow: inset 0 0 0 1px var(--border); }
    .inline-input { width: 100%; height: 100%; margin: -8px -10px; padding: 8px 10px; background-color: var(--bg-input); color: white; border: 2px solid var(--primary); font-size: 13px; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

    .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; border: 1px solid transparent; display: inline-block; }
    .st-pendente { background-color: rgba(210, 153, 34, 0.15); color: #d29922; border-color: rgba(210, 153, 34, 0.3); }
    .st-concluido { background-color: rgba(35, 134, 54, 0.15); color: #238636; border-color: rgba(35, 134, 54, 0.3); }
    .crit-alta { background-color: rgba(248, 81, 73, 0.15); color: #f85149; border-color: rgba(248, 81, 73, 0.3); }
    .crit-media { background-color: rgba(210, 153, 34, 0.15); color: #d29922; }
    .crit-baixa { background-color: rgba(56, 139, 253, 0.15); color: #388bfd; }

    .grid-footer { height: 50px; border-top: 1px solid var(--border); background-color: var(--bg-header); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }

    /* ============================================================================================
      SEÇÃO 9: FLUTUANTES (DROPDOWNS, TOASTS, OVERLAYS)
      ============================================================================================
    */
    .dropdown-wrap { position: relative; }
    .dropdown-menu { position: absolute; top: 110%; left: 0; background-color: var(--bg-panel); border: 1px solid var(--border); padding: 8px; border-radius: 6px; z-index: 100; width: 260px; display: none; flex-direction: column; gap: 2px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .dropdown-menu.show { display: flex; }
    .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; color: var(--text-muted); border-radius: 4px; cursor: pointer; transition: background 0.1s; }
    .menu-item:hover { background-color: var(--bg-hover); color: var(--text-main); }
    .menu-actions { display: flex; gap: 8px; opacity: 0.5; }
    .menu-item:hover .menu-actions { opacity: 1; }

    .bulk-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background-color: var(--primary); color: white; padding: 12px 30px; border-radius: 50px; display: flex; align-items: center; gap: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); z-index: 100; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease; opacity: 0; pointer-events: none; }
    .bulk-bar.visible { transform: translateX(-50%) translateY(0); opacity: 1; pointer-events: auto; }

    .toast-wrap { position: fixed; top: 20px; right: 20px; z-index: 25000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background-color: var(--bg-panel); border-left: 4px solid var(--primary); padding: 15px 25px; border-radius: 6px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 320px; color: var(--text-main); display: flex; align-items: center; gap: 15px; animation: slideInRight 0.4s ease forwards; border: 1px solid var(--border); }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    @keyframes slideInRight { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    #loadingOverlay { position: fixed; inset: 0; background-color: rgba(13, 17, 23, 0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .spinner { width: 60px; height: 60px; border: 6px solid var(--bg-input); border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    .loading-text { margin-top: 20px; font-size: 1.1rem; font-weight: 600; color: var(--text-main); letter-spacing: 0.5px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ============================================================================================
      SEÇÃO 10: MODAIS
      ============================================================================================
    */
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 999; display: none; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal-box { background-color: #1c2128; width: 750px; max-width: 95%; padding: 0; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 25px 50px rgba(0,0,0,0.7); display: flex; flex-direction: column; overflow: hidden; max-height: 90vh; animation: modalZoom 0.2s ease-out; }
    @keyframes modalZoom { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-panel); }
    .modal-header h3 { margin: 0; font-size: 1.2rem; font-weight: 600; }
    .modal-tabs { display: flex; background-color: var(--bg-input); padding: 0 25px; border-bottom: 1px solid var(--border); }
    .modal-tab { padding: 15px 20px; cursor: pointer; color: var(--text-muted); border-bottom: 3px solid transparent; font-size: 0.9rem; font-weight: 600; transition: color 0.2s; }
    .modal-tab:hover { color: var(--text-main); }
    .modal-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .modal-content { padding: 25px; overflow-y: auto; flex: 1; }
    .modal-tab-pane { display: none; }
    .modal-tab-pane.active { display: block; }
    .modal-footer { padding: 20px 25px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background-color: var(--bg-panel); }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group.full { grid-column: span 2; }
    .form-group label { font-weight: 600; color: var(--text-muted); font-size: 0.85rem; }

    .chat-list { display: flex; flex-direction: column; gap: 15px; max-height: 300px; overflow-y: auto; margin-bottom: 15px; padding-right: 10px; }
    .chat-item { background-color: var(--bg-body); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
    .chat-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
    .audit-log { font-family: 'Consolas', 'Courier New', monospace; font-size: 0.85rem; color: var(--text-muted); max-height: 300px; overflow-y: auto; background-color: var(--bg-body); padding: 15px; border-radius: 6px; border: 1px solid var(--border); }
    .audit-item { border-bottom: 1px solid var(--border); padding: 8px 0; }

    /* ============================================================================================
      SEÇÃO 11: CADASTROS
      ============================================================================================
    */
    .cad-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; padding-bottom: 50px; }
    .cad-card { background-color: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; height: 450px; overflow: hidden; }
    .cad-head { padding: 20px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; background-color: rgba(255,255,255,0.02); }
    .cad-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
    .cad-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: var(--bg-input); border-radius: 6px; border: 1px solid transparent; transition: 0.2s; }
    .cad-row:hover { border-color: var(--border); background-color: var(--bg-hover); }
    .cad-input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background-color: var(--bg-panel); }
    
    .file-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .file-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-body); padding: 12px; border-radius: 6px; border: 1px solid var(--border); }
    .file-item a { color: var(--info); text-decoration: none; font-weight: 500; }
    .file-item a:hover { text-decoration: underline; }
  </style>
</head>

<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p class="loading-text" id="loadingText">Conectando ao Google Sheets...</p>
  </div>

  <div id="toastContainer" class="toast-wrap"></div>
  <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display:none" onchange="processarImportacao(this)">

  <div id="loginScreen">
      <div class="login-card">
          <div class="login-logo"><i class="ph-fill ph-fire"></i> Atendimentos Potigás</div>
          <div class="login-title">Bem-vindo</div>
          <div class="login-subtitle">Faça login para acessar o sistema</div>
          <form class="login-form" onsubmit="handleLogin(event)">
              <input type="text" id="loginUser" class="login-input" placeholder="Usuário" required autofocus>
              <input type="password" id="loginPass" class="login-input" placeholder="Senha" required>
              <button type="submit" class="login-btn">Acessar Sistema</button>
          </form>
          <p style="margin-top:20px; font-size:0.8rem; color:var(--text-muted)">Login Padrão: admin / 123456</p>
      </div>
  </div>

  <div id="appContainer">
      <header class="topbar">
        <div class="brand"><i class="ph-fill ph-fire"></i> <span>Atendimentos <small style="color:var(--text-muted); font-weight:400; margin-left:5px">Potigás</small></span></div>
        <div style="display:flex; gap:15px; align-items:center">
          <div class="user-info">
             <div class="user-badge">
                 <div class="user-name" id="displayUser">Usuário</div>
                 <div class="user-role" id="displayRole">Função</div>
             </div>
          </div>
          <span class="badge st-concluido" id="statusBadge"><i class="ph-fill ph-cloud-check"></i> Conectado</span>
          <button class="btn-icon" onclick="forceSync()" title="Forçar Sincronização"><i class="ph ph-arrows-clockwise"></i></button>
          <button class="btn-icon" onclick="handleLogout()" title="Sair"><i class="ph ph-sign-out"></i></button>
        </div>
      </header>

      <nav class="tabs">
        <button class="tab-btn active" onclick="switchTab('painel')">Painel de Controle</button>
        <button class="tab-btn" onclick="switchTab('dashboards')">Dashboards</button>
        <button class="tab-btn" onclick="switchTab('cadastros')">Cadastros</button>
      </nav>

      <div class="main-container">
        
        <div id="painel" class="view-panel active">
          <div class="kpi-container">
             <div class="kpi-card blue"><span class="kpi-label">Total Registros</span><span id="kpiTotal" class="kpi-value">0</span><span class="kpi-sub">Visíveis no grid</span></div>
             <div class="kpi-card orange"><span class="kpi-label">Pendentes</span><span id="kpiPending" class="kpi-value">0</span><span class="kpi-sub">Aguardando ação</span></div>
             <div class="kpi-card red"><span class="kpi-label">Alta Prioridade</span><span id="kpiCrit" class="kpi-value">0</span><span class="kpi-sub">Criticidade Alta</span></div>
             <div class="kpi-card green"><span class="kpi-label">Concluídos</span><span id="kpiDone" class="kpi-value">0</span><span class="kpi-sub">Processo finalizado</span></div>
          </div>

          <div class="toolbar">
            <div class="search-wrap"><i class="ph ph-magnifying-glass"></i><input id="txtBusca" placeholder="Pesquisar em tudo..." onkeyup="filtrarGrid(true)"></div>
            <div class="date-range"><input type="date" id="fDataIni" onchange="filtrarGrid(true)"><span>até</span><input type="date" id="fDataFim" onchange="filtrarGrid(true)"></div>
            <select id="fGerencia" class="filter-select" onchange="filtrarGrid(true)"></select>
            <select id="fAnalista" class="filter-select" onchange="filtrarGrid(true)"></select>
            <select id="fStatus" class="filter-select" onchange="filtrarGrid(true)"></select>
            <div class="v-divider"></div>
            <div class="dropdown-wrap">
              <button class="btn-ghost" onclick="toggleDropdown('colMenu')"><i class="ph ph-columns"></i> Colunas</button>
              <div id="colMenu" class="dropdown-menu"><div id="colList"></div><div style="height:1px; background:var(--border); margin:5px 0"></div><button class="btn-ghost" style="width:100%; justify-content:center" onclick="addNovaColuna()">+ Nova Coluna</button></div>
            </div>
            <button class="btn-ghost" onclick="document.getElementById('fileInput').click()"><i class="ph ph-upload-simple"></i> Importar</button>
            <button class="btn-ghost" onclick="exportarXLSX()"><i class="ph ph-download-simple"></i> Exportar</button>
            <div style="flex:1"></div>
            <button class="btn-primary" onclick="abrirModalCadastro()"><i class="ph ph-plus"></i> Novo Atendimento</button>
          </div>

          <div class="grid-frame">
            <div class="grid-scroll">
              <table id="gridTable">
                <thead id="gridHead"></thead>
                <tbody id="gridBody"></tbody>
              </table>
            </div>
            <div class="grid-footer">
              <span id="pageInfo" style="color:var(--text-muted)">0 registros</span>
              <div style="display:flex; gap:15px; align-items:center">
                <button class="btn-ghost btn-icon" onclick="toggleDensity()" title="Alternar Densidade"><i class="ph ph-rows"></i></button>
                <div class="v-divider" style="height:15px"></div>
                <button class="btn-icon" onclick="mudarPagina(-1)"><i class="ph ph-caret-left"></i></button>
                <span id="pageLabel" style="padding:0 10px; font-weight:600">1 / 1</span>
                <button class="btn-icon" onclick="mudarPagina(1)"><i class="ph ph-caret-right"></i></button>
              </div>
            </div>
          </div>
          
          <div id="bulkBar" class="bulk-bar">
            <span id="bulkCount" style="font-weight:700">0 selecionados</span>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.3)"></div>
            <button class="btn-ghost" style="color:white; border-color:white" onclick="abrirBulkEdit()"><i class="ph ph-pencil-simple"></i> Editar em Massa</button>
            <button class="btn-ghost" style="color:white; background:rgba(248,81,73,0.4); border:none" onclick="bulkDelete()"><i class="ph ph-trash"></i> Excluir</button>
            <button class="btn-icon" onclick="limparSelecao()" style="color:white; margin-left:10px"><i class="ph ph-x"></i></button>
          </div>
        </div>

        <div id="dashboards" class="view-panel">
          <div class="cad-container">
            <div class="cad-card" style="padding:20px"><h3 style="color:var(--text-muted); margin-bottom:15px; font-size:1rem">Atendimentos por Analista</h3><div id="chartAnalistas"></div></div>
            <div class="cad-card" style="padding:20px"><h3 style="color:var(--text-muted); margin-bottom:15px; font-size:1rem">Status Geral</h3><div id="chartStatus"></div></div>
            <div class="cad-card" style="padding:20px"><h3 style="color:var(--text-muted); margin-bottom:15px; font-size:1rem">Distribuição de Criticidade</h3><div id="chartCrit"></div></div>
          </div>
        </div>

        <div id="cadastros" class="view-panel">
          <div class="cad-container">
            <div id="card-gerencias" class="cad-card"></div>
            <div id="card-analistas" class="cad-card"></div>
            <div id="card-usuarios" class="cad-card"></div>
            <div id="card-periodos" class="cad-card"></div>
            <div id="card-status" class="cad-card"></div>
            <div id="card-criticidade" class="cad-card"></div>
          </div>
        </div>

      </div>
  </div>

  <div id="modalCadastro" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header"><h3 id="modalTitle">Registro</h3><button class="btn-icon" onclick="fecharModal('modalCadastro')"><i class="ph ph-x"></i></button></div>
      <div class="modal-tabs">
          <div class="modal-tab active" onclick="switchModalTab('tab-dados')">Dados</div>
          <div class="modal-tab" onclick="switchModalTab('tab-comments')">Comentários</div>
          <div class="modal-tab" onclick="switchModalTab('tab-history')">Histórico</div>
      </div>
      <form onsubmit="salvarRegistro(event)" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
        <input type="hidden" id="editId">
        <div class="modal-content">
            <div id="tab-dados" class="modal-tab-pane active"><div id="formFields" class="form-grid"></div></div>
            <div id="tab-comments" class="modal-tab-pane"><div id="chatList" class="chat-list"></div><div style="display:flex; gap:10px"><input id="newComment" placeholder="Digite uma observação..." style="flex:1"><button type="button" class="btn-primary" onclick="addComment()">Enviar</button></div></div>
            <div id="tab-history" class="modal-tab-pane"><div id="auditLog" class="audit-log"></div></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn-ghost" onclick="fecharModal('modalCadastro')">Cancelar</button><button type="submit" class="btn-primary" id="btnSave">Salvar Registro</button></div>
      </form>
    </div>
  </div>

  <div id="modalAnexos" class="modal-overlay">
    <div class="modal-box" style="width:500px">
      <div class="modal-header"><h3>Gerenciar Anexos</h3><button class="btn-icon" onclick="fecharModal('modalAnexos')"><i class="ph ph-x"></i></button></div>
      <div class="modal-content">
         <input type="hidden" id="anexoId">
         <p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem">Adicione links externos (Google Drive, SharePoint) ou nomes de arquivos.</p>
         <div style="display:flex; gap:10px; margin-bottom:20px"><input id="novoAnexo" placeholder="Cole o link aqui..." style="flex:1"><button class="btn-primary" onclick="adicionarAnexo()">Adicionar</button></div>
         <div id="listaAnexos" class="file-list"></div>
      </div>
    </div>
  </div>

  <div id="modalBulk" class="modal-overlay">
    <div class="modal-box" style="width:450px">
      <div class="modal-header"><h3>Edição em Massa</h3><button class="btn-icon" onclick="fecharModal('modalBulk')"><i class="ph ph-x"></i></button></div>
      <div class="modal-content">
        <p style="color:var(--text-muted); margin-bottom:25px; font-size:1rem">Você está prestes a alterar <b id="bulkTotal" style="color:var(--primary)">0</b> registros selecionados.</p>
        <div class="form-group"><label>Qual campo deseja alterar?</label><select id="bulkField" style="width:100%" onchange="atualizarInputBulk()"></select></div>
        <div class="form-group" style="margin-top:20px"><label>Novo Valor</label><div id="bulkValueContainer"></div></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn-ghost" onclick="fecharModal('modalBulk')">Cancelar</button><button type="button" class="btn-primary" onclick="aplicarBulk()">Aplicar Alterações</button></div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------------------------------------
    // MÓDULO 1: CONFIGURAÇÃO E ESTADO DA APLICAÇÃO
    // ----------------------------------------------------------------------------------
    
    // ⚠️ URL DO GOOGLE APPS SCRIPT - COLE AQUI ⚠️
    const API_URL = "https://script.google.com/macros/s/AKfycbzWrQ4CKUU4r0zmuF1x7BL10XNJuBQaen422luGx2XkCoKvFooJAD0aOI7nmswhzaNl/exec"; 

    const defaultDB = {
        gerencias: ["Faturamento", "TI", "Fiscal", "Comercial"],
        analistas: ["João", "Maria", "Pedro"],
        usuarios: ["admin"],
        periodos: ["10/2025"],
        status: ["Pendente", "Concluído"],
        criticidade: ["Alta", "Média", "Baixa"]
    };
    
    const defaultCols = [
      { id: 'id', label: 'ID (UUID)', width: '50px', type: 'readonly' },
      { id: 'chamado', label: 'Chamado', width: '100px', type: 'text' },
      { id: 'demanda', label: 'Demanda', width: '250px', type: 'text', full: true },
      { id: 'data', label: 'Data', width: '110px', type: 'date' },
      { id: 'gerencia', label: 'Gerência', width: '130px', type: 'select', source: 'gerencias' },
      { id: 'analista', label: 'Analista', width: '130px', type: 'select', source: 'analistas' },
      { id: 'status', label: 'Status', width: '110px', type: 'select', source: 'status' },
      { id: 'criticidade', label: 'Criticidade', width: '100px', type: 'select', source: 'criticidade' },
      { id: 'usuario', label: 'Usuário Resp.', width: '130px', type: 'select', source: 'usuarios' },
      { id: 'anexos', label: 'Anexos', width: '70px', type: 'special_file' }
    ];

    let currentUser = null;
    let db = JSON.parse(JSON.stringify(defaultDB));
    let dados = [];
    let cols = JSON.parse(localStorage.getItem('pg_cols_v27')) || JSON.parse(JSON.stringify(defaultCols));
    let visibleCols = new Set(cols.map(c => c.id));
    let sortConfig = { col: null, order: 'asc' };
    let selectedIds = new Set();
    let currentPage = 1;
    const itemsPerPage = 15;
    let filteredData = [];

    // ----------------------------------------------------------------------------------
    // MÓDULO 2: INICIALIZAÇÃO E LOGIN
    // ----------------------------------------------------------------------------------
    window.onload = () => {
        // Evento Global para fechar menus dropdown
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.dropdown-wrap')) {
                document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
            }
        });
    };

    async function handleLogin(e) {
        e.preventDefault();
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        
        if (API_URL.includes("COLE_SUA")) return alert("URL não configurada!");
        
        toggleLoading(true, "Autenticando...");
        
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'login', data: { user: u, pass: p } })
            });
            
            const json = await res.json();

            if (json.status === 'success') {
                currentUser = { user: json.user, role: json.role };
                if (json.data && json.data.dados) dados = json.data.dados;
                if (json.data && json.data.db) db = json.data.db;
                
                // Se vazio (primeiro acesso), carrega defaults
                if(!json.data || !json.data.db) {
                    await sendToApi('config', defaultDB);
                    db = defaultDB;
                }

                document.getElementById('displayUser').innerText = currentUser.user;
                document.getElementById('displayRole').innerText = currentUser.role;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                
                renderAllComponents();
                showToast(`Bem-vindo, ${currentUser.user}!`, 'success');
            } else {
                showToast(json.message || "Falha no login", "error");
            }
        } catch (err) {
            console.error(err);
            showToast("Erro de conexão.", "error");
        } finally {
            toggleLoading(false);
        }
    }

    function handleLogout() {
        currentUser = null;
        dados = [];
        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('loginPass').value = '';
    }

    // ----------------------------------------------------------------------------------
    // MÓDULO 3: LÓGICA CENTRAL
    // ----------------------------------------------------------------------------------
    function renderAllComponents() {
        populateFilters();
        renderCadastros();
        renderColMenu();
        filtrarGrid(true);
        updateCharts();
        updateKPIs();
    }

    async function sendToApi(action, payload) {
        toggleLoading(true, "Salvando...");
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: action, data: payload })
            });
            const json = await res.json();
            
            if (json.status === 'success' || json.result === 'success') {
                if (json.data && json.data.dados) dados = json.data.dados;
                if (json.data && json.data.db) db = json.data.db;
                renderAllComponents();
                return true;
            } else {
                throw new Error(json.message);
            }
        } catch (err) {
            showToast("Erro: " + err.message, "error");
            return false;
        } finally {
            toggleLoading(false);
        }
    }

    // --- GRID ---
    function filtrarGrid(resetPage) {
        if (resetPage) currentPage = 1;
        
        const busca = document.getElementById('txtBusca').value.toLowerCase();
        const fGer = document.getElementById('fGerencia').value;
        const fAna = document.getElementById('fAnalista').value;
        const fStat = document.getElementById('fStatus').value;
        const dIni = document.getElementById('fDataIni').value;
        const dFim = document.getElementById('fDataFim').value;

        filteredData = dados.filter(d => {
            const txtMatch = Object.values(d).some(v => v && String(v).toLowerCase().includes(busca));
            if (!txtMatch) return false;
            if (fGer && d.gerencia !== fGer) return false;
            if (fAna && d.analista !== fAna) return false;
            if (fStat && d.status !== fStat) return false;
            if (dIni || dFim) {
                if (!d.data) return false;
                if (dIni && d.data < dIni) return false;
                if (dFim && d.data > dFim) return false;
            }
            return true;
        });

        if (sortConfig.col) {
            filteredData.sort((a, b) => {
                let valA = a[sortConfig.col] || '';
                let valB = b[sortConfig.col] || '';
                if (!isNaN(valA) && !isNaN(valB) && valA !== '' && valB !== '') { valA = Number(valA); valB = Number(valB); }
                else { valA = String(valA).toLowerCase(); valB = String(valB).toLowerCase(); }
                if (valA < valB) return sortConfig.order === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.order === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        renderGrid();
        updateKPIs();
    }

    function renderGrid() {
        const tbody = document.getElementById('gridBody');
        const thead = document.getElementById('gridHead');
        
        let headHtml = `<tr><th class="col-check"><input type="checkbox" onchange="toggleSelectAll(this)"></th>`;
        cols.forEach(c => {
            if (!visibleCols.has(c.id)) return;
            let style = sortConfig.col === c.id ? 'color:var(--primary)' : '';
            let icon = sortConfig.col === c.id ? (sortConfig.order === 'asc' ? '<i class="ph-fill ph-caret-up"></i>' : '<i class="ph-fill ph-caret-down"></i>') : '';
            headHtml += `<th style="width:${c.width}"><div class="th-inner" style="${style}" onclick="doSort('${c.id}')"><span>${c.label}</span> ${icon}</div><div class="resizer" onmousedown="initResize(event, '${c.id}')"></div></th>`;
        });
        headHtml += `<th style="width:90px">Ações</th></tr>`;
        thead.innerHTML = headHtml;

        const total = filteredData.length;
        const totalPages = Math.ceil(total / itemsPerPage) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        const start = (currentPage - 1) * itemsPerPage;
        const pageData = filteredData.slice(start, start + itemsPerPage);
        
        document.getElementById('pageInfo').innerText = `${total} registros`;
        document.getElementById('pageLabel').innerText = `${currentPage} / ${totalPages}`;

        tbody.innerHTML = pageData.map(d => {
            const isSel = selectedIds.has(d.id);
            let rowClass = "";
            let alertIcon = "";
            if (d.criticidade === 'Alta' || d.criticidade === 'Crítico') rowClass += " row-critical";
            if (d.data && (d.status === 'Pendente')) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(d.data)) / (1000 * 60 * 60 * 24));
                if (diffDays > 7) { rowClass += " row-late"; alertIcon = `<i class="ph-fill ph-fire" style="color:var(--danger); margin-left:5px" title="Atrasado"></i>`; }
            }

            let rowHtml = `<tr class="${rowClass}" style="${isSel ? 'background:rgba(35,134,54,0.15)' : ''}">
              <td class="col-check"><input type="checkbox" ${isSel ? 'checked' : ''} onchange="toggleSelect('${d.id}')"></td>`;
            
            cols.forEach(c => {
                if (!visibleCols.has(c.id)) return;
                let val = d[c.id] || '';
                let display = val;

                if (c.id === 'status') {
                    let cls = 'badge';
                    if (val.includes('Concluído') || val.includes('Fechado')) cls = 'st-concluido';
                    else if (val.includes('Pend')) cls = 'st-pendente';
                    display = `<span class="badge ${cls}">${val}</span>`;
                } else if (c.id === 'criticidade') {
                    let cls = 'badge';
                    if (val === 'Alta' || val === 'Crítico') cls = 'crit-alta';
                    else if (val === 'Média') cls = 'crit-media';
                    else cls = 'crit-baixa';
                    display = `<span class="badge ${cls}">${val}</span>`;
                } else if (c.type === 'date' && val) {
                    display = val.split('-').reverse().join('/');
                } else if (c.type === 'special_file') {
                    const qtd = (d.anexos || []).length;
                    display = `<button class="btn-icon" onclick="abrirAnexos('${d.id}')"><i class="ph-fill ph-paperclip"></i> ${qtd || ''}</button>`;
                }
                
                if (c.id === 'chamado') display += alertIcon;

                if (c.type !== 'special_file' && c.id !== 'id') {
                    const safeVal = String(val).replace(/"/g, '&quot;');
                    rowHtml += `<td class="editable" ondblclick="inlineEdit(this, '${d.id}', '${c.id}', '${safeVal}')">${display}</td>`;
                } else {
                    rowHtml += `<td>${display}</td>`;
                }
            });
            
            rowHtml += `<td><div style="display:flex; gap:5px">
                 <button class="btn-icon" onclick="abrirModalCadastro('${d.id}')"><i class="ph ph-pencil-simple"></i></button>
                 <button class="btn-icon danger" onclick="excluirRegistro('${d.id}')"><i class="ph ph-trash"></i></button>
            </div></td></tr>`;
            
            return rowHtml;
        }).join('');
        updateBulkBar();
    }

    // --- CRUD ---
    function abrirModalCadastro(id = null) {
        document.getElementById('editId').value = id || '';
        document.getElementById('modalTitle').innerText = id ? 'Editar Registro' : 'Novo Registro';
        switchModalTab('tab-dados');

        const item = id ? dados.find(d => d.id == id) : {};
        const container = document.getElementById('formFields');
        container.innerHTML = '';

        cols.forEach(c => {
            if (c.id === 'id' || c.type === 'special_file') return;
            const div = document.createElement('div');
            div.className = `form-group ${c.full ? 'full' : ''}`;
            div.innerHTML = `<label>${c.label}</label>`;
            let input;
            const val = item[c.id] || '';
            if (c.source && db[c.source]) {
                input = `<select id="in_${c.id}" style="width:100%"><option value="">Selecione...</option>${db[c.source].map(o => `<option ${o == val ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
            } else {
                let type = c.type === 'date' ? 'date' : 'text';
                input = `<input id="in_${c.id}" type="${type}" value="${val}" style="width:100%">`;
            }
            div.innerHTML += input;
            container.appendChild(div);
        });

        if (id) {
            renderComments(item.comments || []);
            renderAudit(item.history || []);
        } else {
            document.getElementById('chatList').innerHTML = '<p style="padding:20px; text-align:center; color:var(--text-muted)">Salve o registro para adicionar comentários.</p>';
            document.getElementById('auditLog').innerHTML = '';
        }
        toggleModal('modalCadastro', true);
    }

    async function salvarRegistro(e) {
        e.preventDefault();
        const idInput = document.getElementById('editId').value;
        const id = idInput === "" ? null : idInput;
        let novo = id ? { ...dados.find(d => d.id == id) } : { id: crypto.randomUUID(), anexos: [], comments: [], history: [] };
        let changes = [];

        cols.forEach(c => {
            if (c.id !== 'id' && c.type !== 'special_file') {
                const el = document.getElementById(`in_${c.id}`);
                if (el && novo[c.id] != el.value) {
                    changes.push(`${c.label}: ${el.value}`);
                    novo[c.id] = el.value;
                }
            }
        });

        if (changes.length > 0 || !id) {
            const action = id ? "Editado" : "Criado";
            const logEntry = `${new Date().toLocaleString()} - ${currentUser.user}: ${action}. ${changes.join(', ')}`;
            if (!novo.history) novo.history = [];
            novo.history.unshift(logEntry);
        }

        if (!id) dados.unshift(novo);
        const success = await sendToApi('save', novo);
        if (success) { toggleModal('modalCadastro', false); showToast('Salvo com sucesso!', 'success'); }
    }

    async function excluirRegistro(id) {
        if (confirm('Deseja realmente excluir?')) {
            const success = await sendToApi('delete', { id: id });
            if (success) showToast('Registro removido.', 'info');
        }
    }

    // --- CADASTROS ---
    function renderCadastros() {
        const keys = ['gerencias', 'analistas', 'usuarios', 'periodos', 'status', 'criticidade'];
        keys.forEach(key => {
            const el = document.getElementById(`card-${key}`);
            if (el) {
                const title = key.charAt(0).toUpperCase() + key.slice(1);
                el.innerHTML = `
                   <div class="cad-head"><span>${title}</span><span class="badge st-pendente">${(db[key] || []).length}</span></div>
                   <div class="cad-list">${(db[key] || []).map(v => `
                        <div class="cad-row"><span>${v}</span><button class="btn-icon danger" onclick="delCad('${key}','${v}')"><i class="ph ph-trash"></i></button></div>
                   `).join('')}</div>
                   <div class="cad-input-area"><input id="new-${key}" placeholder="Novo..." style="flex:1" onkeydown="if(event.key==='Enter') addCad('${key}')"><button class="btn-primary" onclick="addCad('${key}')">+</button></div>
                `;
            }
        });
    }
    async function addCad(key) {
        const v = document.getElementById(`new-${key}`).value.trim();
        if (v && !db[key].includes(v)) { db[key].push(v); await sendToApi('config', db); }
    }
    async function delCad(key, v) {
        if (confirm(`Remover "${v}"?`)) { db[key] = db[key].filter(x => x !== v); await sendToApi('config', db); }
    }

    // --- HELPERS UI ---
    function toggleLoading(show, msg) { 
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; 
        if (msg) document.getElementById('loadingText').innerText = msg; 
    }
    function showToast(msg, type = 'info') {
        const div = document.createElement('div'); div.className = `toast ${type}`;
        div.innerHTML = `<i class="ph-fill ${type==='success'?'ph-check-circle':type==='error'?'ph-warning-circle':'ph-info'}"></i> ${msg}`;
        document.getElementById('toastContainer').appendChild(div);
        setTimeout(() => div.remove(), 3500);
    }
    function toggleModal(id, open) { document.getElementById(id).style.display = open ? 'flex' : 'none'; }
    function fecharModal(id) { toggleModal(id, false); }
    function switchTab(id) {
        document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        if (id === 'dashboards') updateCharts();
    }
    function toggleDropdown(id) { const el = document.getElementById(id); el.style.display = el.style.display === 'flex' ? 'none' : 'flex'; }
    function populateFilters() { 
        const fill = (id, list) => document.getElementById(id).innerHTML = `<option value="">Todos</option>` + (list || []).map(i => `<option>${i}</option>`).join('');
        fill('fGerencia', db.gerencias); fill('fAnalista', db.analistas); fill('fStatus', db.status);
    }
    function doSort(colId) { 
        if (sortConfig.col === colId) sortConfig.order = sortConfig.order === 'asc' ? 'desc' : 'asc';
        else { sortConfig.col = colId; sortConfig.order = 'asc'; }
        filtrarGrid(false); 
    }
    function mudarPagina(delta) { currentPage += delta; renderGrid(); }
    function toggleSelect(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); renderGrid(); }
    function toggleSelectAll(chk) { if (chk.checked) filteredData.forEach(d => selectedIds.add(d.id)); else selectedIds.clear(); renderGrid(); }
    function limparSelecao() { selectedIds.clear(); renderGrid(); }
    function updateBulkBar() { const b = document.getElementById('bulkBar'); if (selectedIds.size > 0) { b.classList.add('visible'); document.getElementById('bulkCount').innerText = `${selectedIds.size} selecionados`; } else b.classList.remove('visible'); }
    function toggleDensity() { document.getElementById('gridTable').classList.toggle('compact'); }
    function resetFactory() { if (confirm('Deseja resetar o cache local?')) { localStorage.clear(); location.reload(); } }
    function updateKPIs() { document.getElementById('kpiTotal').innerText = filteredData.length; }
    function renderColMenu() { document.getElementById('colList').innerHTML = cols.map(c => `<div class="menu-item" onclick="toggleCol('${c.id}')"><span>${c.label}</span>${visibleCols.has(c.id)?'<i class="ph-fill ph-eye"></i>':'<i class="ph ph-eye-slash"></i>'}</div>`).join(''); }
    function toggleCol(id) { if (visibleCols.has(id)) visibleCols.delete(id); else visibleCols.add(id); renderColMenu(); renderGrid(); }
    function addNovaColuna() { const n = prompt("Nome:"); if(n) { cols.push({ id: n.toLowerCase()+'_'+Date.now(), label: n, width: '150px', type: 'text' }); localStorage.setItem('pg_cols_v26', JSON.stringify(cols)); renderColMenu(); renderGrid(); } }
    function initResize(e, colId) { 
        const th = e.target.closest('th'); const startX = e.pageX; const startW = th.offsetWidth;
        document.body.classList.add('is-resizing');
        function mm(ev) { th.style.width = (startW + (ev.pageX - startX)) + 'px'; }
        function mu() { document.body.classList.remove('is-resizing'); const c = cols.find(x => x.id === colId); if(c) c.width = th.style.width; saveData(); window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); }
        window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
    }
    function abrirAnexos(id) { document.getElementById('anexoId').value = id; renderListaAnexos(dados.find(d => d.id == id).anexos || []); toggleModal('modalAnexos', true); }
    function renderListaAnexos(l) { document.getElementById('listaAnexos').innerHTML = l.map((f, i) => `<div class="file-item"><a href="${f.startsWith('http')?f:'#'}" target="_blank">${f}</a><button class="btn-icon danger" onclick="rmAnexo(${i})"><i class="ph ph-trash"></i></button></div>`).join(''); }
    async function adicionarAnexo() { const id = document.getElementById('anexoId').value; const val = document.getElementById('novoAnexo').value; if (val) { const r = dados.find(d => d.id == id); if(!r.anexos) r.anexos=[]; r.anexos.push(val); await sendToApi('save', r); renderListaAnexos(r.anexos); } }
    async function rmAnexo(i) { const id = document.getElementById('anexoId').value; const r = dados.find(d => d.id == id); r.anexos.splice(i, 1); await sendToApi('save', r); renderListaAnexos(r.anexos); }
    function abrirBulkEdit() { document.getElementById('bulkField').innerHTML = cols.filter(c=>c.id!=='id').map(c=>`<option value="${c.id}">${c.label}</option>`).join(''); toggleModal('modalBulk', true); }
    function atualizarInputBulk() { const fid = document.getElementById('bulkField').value; const col = cols.find(c => c.id === fid); const c = document.getElementById('bulkValueContainer'); if(col.source && db[col.source]) c.innerHTML = `<select id="bulkValue" style="width:100%">${db[col.source].map(o => `<option>${o}</option>`).join('')}</select>`; else c.innerHTML = `<input id="bulkValue" style="width:100%">`; }
    async function aplicarBulk() { const f = document.getElementById('bulkField').value; const v = document.getElementById('bulkValue').value; toggleLoading(true); for (let id of selectedIds) { let r = dados.find(d => d.id == id); if(r) { r[f] = v; await sendToApi('save', r); } } toggleLoading(false); toggleModal('modalBulk', false); limparSelecao(); showToast('Atualizado!', 'success'); }
    async function bulkDelete() { if (confirm('Excluir?')) { toggleLoading(true); for (let id of selectedIds) { await sendToApi('delete', { id: id }); } toggleLoading(false); limparSelecao(); showToast('Excluídos!', 'info'); } }
    function switchModalTab(t) { document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active')); document.querySelectorAll('.modal-tab-pane').forEach(el => el.classList.remove('active')); event.target.classList.add('active'); document.getElementById(t).classList.add('active'); }
    async function addComment() { const id = document.getElementById('editId').value; const txt = document.getElementById('newComment').value; if(txt && id) { const r = dados.find(d => d.id == id); if(!r.comments) r.comments = []; r.comments.unshift({user: currentUser.user, date: new Date().toLocaleString(), text: txt}); await sendToApi('save', r); document.getElementById('newComment').value = ''; renderComments(r.comments); } }
    function renderComments(l) { document.getElementById('chatList').innerHTML = l.map(c => `<div class="chat-item"><div class="chat-meta"><span>${c.user}</span><span>${c.date}</span></div><div>${c.text}</div></div>`).join(''); }
    function renderAudit(l) { document.getElementById('auditLog').innerHTML = l.map(i => `<div class="audit-item">${i}</div>`).join(''); }
    function inlineEdit(td, id, colId, val) { if(td.querySelector('.inline-input')) return; const col = cols.find(c=>c.id===colId); let html = ''; if(col.source && db[col.source]) html = `<select class="inline-input" onblur="salvarInline(this,'${id}','${colId}')">${db[col.source].map(o=>`<option ${o==val?'selected':''}>${o}</option>`).join('')}</select>`; else html = `<input class="inline-input" value="${val}" onblur="salvarInline(this,'${id}','${colId}')">`; td.innerHTML = html; td.querySelector('.inline-input').focus(); }
    async function salvarInline(el, id, colId) { const row = dados.find(d=>d.id==id); if(row && row[colId]!=el.value) { let cp={...row}; cp[colId]=el.value; await sendToApi('save', cp); showToast('Atualizado!'); } renderGrid(); }
    function updateCharts() { if(typeof ApexCharts === 'undefined') return; const cnt = (f) => { const m={}; dados.forEach(d=>{if(d[f]) m[d[f]]=(m[d[f]]||0)+1}); return m; }; const mk = (id, type, d) => { document.getElementById(id).innerHTML = ''; new ApexCharts(document.querySelector(`#${id}`), { chart: {type, height:280, background:'transparent', toolbar:{show:false}}, theme:{mode:'dark'}, series: type==='bar'?[{data:Object.values(d)}]:Object.values(d), labels:Object.keys(d), colors: ['#238636','#d29922','#f85149'] }).render(); }; mk('chartAnalistas', 'bar', cnt('analista')); mk('chartStatus', 'donut', cnt('status')); mk('chartCrit', 'pie', cnt('criticidade')); }
    function processarImportacao(input) { const f=input.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const wb=XLSX.read(e.target.result, {type:'array'}); const json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]); json.forEach(row=>{ let n={id:crypto.randomUUID(), anexos:[], comments:[], history:[]}; cols.forEach(c=>{ if(c.id!=='id'&&c.type!=='special_file'){ const k=Object.keys(row).find(x=>x.toLowerCase()===c.label.toLowerCase()); if(k) n[c.id]=row[k]; } }); dados.push(n); }); sendToApi('save', dados[dados.length-1]); }; r.readAsArrayBuffer(f); }
    function exportarXLSX() { const ws = XLSX.utils.json_to_sheet(dados); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Dados"); XLSX.writeFile(wb, "Potigas.xlsx"); }
  </script>
</body>
</html>
